<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض وتحديث عدد الحضور</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            margin-top: 15px;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        h1 { 
            color: #2c3e50; 
            margin-bottom: 10px; 
            font-size: 28px; 
            word-wrap: break-word;
        }
        .subtitle { 
            color: #7f8c8d; 
            font-size: 16px; 
        }
        .csv-info {
            background-color: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-right: 4px solid #3498db;
            font-size: 15px;
            line-height: 1.6;
        }
        .csv-info h3 { 
            color: #3498db; 
            margin-bottom: 10px; 
            font-size: 18px;
        }
        .attendance-display {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            border-radius: 15px;
            padding: 30px 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            color: white;
            position: relative;
            overflow: hidden;
        }
        .attendance-display::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 5px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f1c40f, #e74c3c);
        }
        .attendance-label { 
            font-size: 18px; 
            margin-bottom: 15px; 
            opacity: 0.9; 
        }
        .attendance-value { 
            font-size: 60px; 
            font-weight: bold; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
            margin: 10px 0; 
        }
        .attendance-unit { 
            font-size: 20px; 
            opacity: 0.8; 
        }
        .last-update {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
        .update-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            border: 1px solid #e9ecef;
        }
        .update-section h2 { 
            color: #2c3e50; 
            margin-bottom: 15px; 
            text-align: center; 
            font-size: 20px; 
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        button {
            padding: 14px 18px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .fetch-btn { 
            background-color: #2ecc71; 
            color: white; 
        }
        .fetch-btn:hover { 
            background-color: #27ae60; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(46,204,113,0.3); 
        }
        .auto-update-btn { 
            background-color: #9b59b6; 
            color: white; 
        }
        .auto-update-btn:hover { 
            background-color: #8e44ad; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(155,89,182,0.3); 
        }
        .open-link-btn { 
            background-color: #f39c12; 
            color: white; 
        }
        .open-link-btn:hover { 
            background-color: #e67e22; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(243,156,18,0.3); 
        }
        .status { 
            margin-top: 20px; 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
            font-weight: 500; 
            display: none; 
            font-size: 14px;
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .loading { 
            display: inline-block; 
            width: 18px; 
            height: 18px; 
            border: 3px solid rgba(255,255,255,.3); 
            border-radius: 50%; 
            border-top-color: #fff; 
            animation: spin 1s ease-in-out infinite; 
            margin-left: 10px; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* تحسينات إضافية للشاشات الصغيرة جداً */
        @media (max-width: 480px) {
            .container { 
                padding: 15px; 
            }
            h1 { 
                font-size: 24px; 
            }
            .attendance-value { 
                font-size: 50px; 
            }
            .attendance-label { 
                font-size: 16px; 
            }
            .attendance-unit { 
                font-size: 18px; 
            }
            .csv-info {
                padding: 12px;
                font-size: 14px;
            }
            .csv-info h3 {
                font-size: 16px;
            }
            button {
                padding: 12px 15px;
                font-size: 15px;
            }
        }
        
        /* تحسينات للشاشات المتوسطة والكبيرة */
        @media (min-width: 768px) {
            .button-group {
                flex-direction: row;
            }
            button {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>متابعة الحضور</h1>
            <p class="subtitle">عرض وتحديث عدد الحضور</p>
        </div>
        
        <div class="csv-info">
            <h3>السلام عليكم ورحمة الله وبركاتة</h3>
            <p>يسعدنا ويشرفنا أن نرحب بكم في هذا المؤتمر، ونتمنى أن يكون لقاءً مثمرًا يحقق الأهداف المنشودة، ويعزز تبادل الخبرات والمعرفة بين المشاركين.
            أهلاً وسهلاً بكم جميعًا، ونتمنى لكم وقتًا مليئًا بالفائدة والتعاون.</p>
            <p><strong></strong> <a href="#" id="csvLink"></a></p>
        </div>
        
        <div class="attendance-display">
            <div class="attendance-label">عدد الحضور الحالي</div>
            <div class="attendance-value" id="attendanceValue">--</div>
            <div class="attendance-unit">حاضر</div>
            <div class="last-update" id="lastUpdate">آخر تحديث: --</div>
        </div>
        
        <div class="update-section">
            <div class="button-group">
                <button class="fetch-btn" id="fetchData">
                    <span class="loading" id="fetchLoading"></span>
                    جلب البيانات
                </button>
                <button class="auto-update-btn" id="autoUpdate">
                    <span class="loading" id="autoUpdateLoading"></span>
                    التحديث التلقائي
                </button>
                <!-- ✅ الزر الجديد لفتح الرابط -->
                <button class="open-link-btn" onclick="window.open('https://attendees-1.netlify.app/', '_blank')">
                    فتح صفحة الحضور
                </button>
            </div>
            
            <div class="status" id="statusMessage"></div>
        </div>
    </div>
        
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const attendanceValueElement = document.getElementById('attendanceValue');
            const lastUpdateElement = document.getElementById('lastUpdate');
            const fetchDataButton = document.getElementById('fetchData');
            const autoUpdateButton = document.getElementById('autoUpdate');
            const statusMessage = document.getElementById('statusMessage');
            const fetchLoading = document.getElementById('fetchLoading');
            const autoUpdateLoading = document.getElementById('autoUpdateLoading');
            const csvLink = document.getElementById('csvLink');
            
            let autoUpdateInterval = null;
            let isAutoUpdateActive = false;
            const CSV_URL = 'https://docs.google.com/spreadsheets/d/1f1HNLFlReMt5evkSCo06uGBh9l3wPQusSMPGyHEyBoo/gviz/tq?tqx=out:csv&sheet=تسجيل%20الحضور';
            csvLink.href = CSV_URL;

            function updateLastUpdateTime() {
                const now = new Date();
                lastUpdateElement.textContent = `آخر تحديث: ${now.toLocaleTimeString('ar-EG')}`;
            }

            async function fetchAttendanceData(showSuccessMessage = true) {
                try {
                    if (isAutoUpdateActive) autoUpdateLoading.style.display = 'inline-block';
                    else { fetchLoading.style.display = 'inline-block'; fetchDataButton.disabled = true; }

                    const response = await fetch(CSV_URL);
                    if (!response.ok) throw new Error('فشل في جلب البيانات من الخادم');

                    const csvText = await response.text();
                    const rows = csvText.split('\n');
                    if (rows.length > 0) {
                        const firstRow = rows[0].split(',');
                        if (firstRow.length >= 4) {
                            const value = firstRow[3] ? firstRow[3].trim() : '0';
                            attendanceValueElement.textContent = value;
                            updateLastUpdateTime();
                            if (showSuccessMessage) showStatus('تم جلب عدد الحضور بنجاح!', 'success');
                        } else throw new Error('لا توجد بيانات كافية في ملف CSV');
                    } else throw new Error('ملف CSV فارغ');
                } catch (error) {
                    console.error('Error fetching data:', error);
                    attendanceValueElement.textContent = '--';
                    showStatus('فشل في جلب البيانات. تأكد من اتصال الإنترنت وحاول مرة أخرى.', 'error');
                } finally {
                    autoUpdateLoading.style.display = 'none';
                    fetchLoading.style.display = 'none';
                    fetchDataButton.disabled = false;
                }
            }

            function toggleAutoUpdate() {
                if (autoUpdateInterval) {
                    clearInterval(autoUpdateInterval);
                    autoUpdateInterval = null;
                    isAutoUpdateActive = false;
                    autoUpdateButton.textContent = 'التحديث التلقائي';
                    showStatus('تم إيقاف التحديث التلقائي.', 'success');
                } else {
                    isAutoUpdateActive = true;
                    autoUpdateInterval = setInterval(() => fetchAttendanceData(false), 5000);
                    autoUpdateButton.textContent = 'إيقاف التحديث التلقائي';
                    showStatus('تم تفعيل التحديث التلقائي. يتم تحديث البيانات كل 5 ثوانٍ.', 'success');
                    fetchAttendanceData(false);
                }
            }

            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status ' + type;
                statusMessage.style.display = 'block';
                setTimeout(() => { statusMessage.style.display = 'none'; }, 5000);
            }

            fetchDataButton.addEventListener('click', () => fetchAttendanceData(true));
            autoUpdateButton.addEventListener('click', toggleAutoUpdate);
            fetchAttendanceData(false);
        });
    </script>
</body>
</html>

